# Airdrop Script Security Measures

## Защита от уязвимостей

### 1. Права доступа на файлы
- **Скрипт**: `chmod 500` (только владелец может читать и выполнять)
- **CSV файл**: `chmod 400` (только владелец может читать)
- **State файл**: `chmod 600` (только владелец может читать/писать)

### 2. Защита приватного ключа
- Использует зашифрованный ключ из `~/.secure_keys/private_key.enc`
- Требует `PRIVATE_KEY_PASSPHRASE` из `web3/.env`
- Fallback на `PRIVATE_KEY` только с предупреждением

### 3. Валидация CSV файла

#### Проверка пути
- CSV_PATH должен быть внутри проекта (защита от path traversal)
- Нельзя указать файл вне проекта через `../`

#### Проверка целостности (опционально)
- Установите `CSV_HASH` в `web3/.env` для проверки SHA256 хеша
- Генерация хеша: `node web3/scripts/generate-csv-hash.js`
- При изменении CSV скрипт выдаст ошибку

#### Валидация данных
- Проверка формата адресов (ethers.utils.isAddress)
- Проверка положительных сумм
- Защита от экстремально больших сумм (максимум 1 миллиард токенов)
- Автоматическое суммирование дубликатов адресов

### 4. Whitelist проверка (опционально)
- Установите `AIRDROP_WHITELIST` в `web3/.env` с адресами через запятую
- Только адреса из whitelist могут получить токены
- Проверка выполняется при загрузке CSV и перед каждой транзакцией

### 5. Лимиты на суммы
- `MAX_TOKENS_PER_ADDRESS` - максимальная сумма токенов на один адрес
- Защита от ошибок в CSV с огромными суммами

### 6. Защита от отправки самому себе
- Проверка, что адрес получателя != адрес отправителя
- Выполняется при загрузке CSV и перед каждой транзакцией

### 7. Защита State файла
- State файл защищен правами доступа
- Валидация данных при загрузке state
- Защита от подделки прогресса отправки

## Переменные окружения для безопасности

```bash
# Обязательные
PRIVATE_KEY_PASSPHRASE=your_passphrase_here

# Опциональные (рекомендуется)
CSV_HASH=sha256_hash_of_csv_file
AIRDROP_WHITELIST=0xAddress1,0xAddress2,0xAddress3
MAX_TOKENS_PER_ADDRESS=1000000
```

## Как использовать

1. **Генерация хеша CSV**:
   ```bash
   node web3/scripts/generate-csv-hash.js
   ```
   Добавьте полученный хеш в `web3/.env` как `CSV_HASH=...`

2. **Настройка whitelist** (опционально):
   ```bash
   # В web3/.env
   AIRDROP_WHITELIST=0xAddress1,0xAddress2,0xAddress3
   ```

3. **Установка лимита** (опционально):
   ```bash
   # В web3/.env
   MAX_TOKENS_PER_ADDRESS=1000000
   ```

## Обнаруженные и исправленные уязвимости

1. ✅ **Изменение скрипта** - Защищено правами доступа (500)
2. ✅ **Изменение CSV** - Защищено правами доступа (400) + проверка хеша
3. ✅ **Path traversal** - Валидация пути CSV
4. ✅ **Отправка самому себе** - Проверка адреса получателя
5. ✅ **Неавторизованные адреса** - Whitelist проверка
6. ✅ **Огромные суммы** - Лимиты и валидация
7. ✅ **Подделка state** - Защита правами доступа
8. ✅ **Невалидные данные** - Валидация адресов и сумм

## Рекомендации

1. Всегда используйте `CSV_HASH` для проверки целостности
2. Используйте `AIRDROP_WHITELIST` для ограничения получателей
3. Установите `MAX_TOKENS_PER_ADDRESS` для защиты от ошибок
4. Регулярно проверяйте права доступа на файлы
5. Используйте `DRY_RUN=1` для тестирования перед реальной отправкой

